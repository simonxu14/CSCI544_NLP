Credit to Rowling:  she clearly DID have the whole story in mind the whole way through.  Not perfectly realised, perhaps, but an honest and satisfying conclusion to a great story & characters.  She played fair with them, and with the reader.